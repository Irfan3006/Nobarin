---
// src/pages/index.astro
import MainLayout from "../layouts/MainLayout.astro";
import { fetchWithCache } from "../lib/movieCache"; // Cache

let heroMovies = [];
let initialGrid = [];
let isError = false;

try {
  const data = await fetchWithCache("https://zeldvorik.ru/apiv3/api.php?action=trending&page=1", 15 * 60 * 1000);

  if (data && data.success) {
    heroMovies = data.items.slice(0, 5);
    initialGrid = data.items;
  } else {
    isError = true;
  }
} catch (e) {
  console.error("API Error di Homepage:", (e as Error).message);
  isError = true;
}
---

<MainLayout title={isError ? "Terjadi Kesalahan - Nobarin" : "Nobarin - Nonton Bareng Film & Series Terlengkap"}>
{
    isError ? (
      <div class="h-[80vh] w-full flex flex-col items-center justify-center bg-dark text-center px-6">
        <div class="relative mb-8">
          <div class="absolute inset-0 bg-purple-600 blur-3xl opacity-20 rounded-full animate-pulse"></div>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-purple-500 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        
        <h1 class="text-3xl md:text-5xl font-black text-white mb-4">Waduh, Gagal Memuat Data</h1>
        <p class="text-gray-400 max-w-md mb-8 leading-relaxed">
          Sepertinya ada masalah koneksi ke server film kami. Coba refresh halaman ya.
        </p>

        <button 
          onclick="window.location.reload()" 
          class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-full font-bold flex items-center gap-2 transition-all active:scale-95 shadow-lg shadow-purple-600/30 group cursor-pointer"
        >
          <svg class="w-5 h-5 group-hover:rotate-180 transition-transform duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <span>Coba Lagi</span>
        </button>
      </div>

    ) : (
      <>
        <section class="relative h-[80vh] w-full pt-20" id="heroSection">
          <div class="swiper heroSwiper h-full">
            <div class="swiper-wrapper" id="heroWrapper">
              {
                heroMovies.map((item: any) => (
                  <div class="swiper-slide relative bg-dark overflow-hidden h-full">
                    <div class="absolute inset-0 z-0">
                      <img src={item.poster} class="w-full h-full object-cover scale-110 blur-xl opacity-20" loading="eager" />
                      <div class="absolute inset-0 bg-gradient-to-b from-dark/10 via-dark/80 to-dark" />
                    </div>
                    <div class="relative z-10 h-full container mx-auto px-6 flex flex-col md:flex-row items-center justify-center gap-6 md:gap-12 pt-10 md:pt-0">
                      <div class="block w-32 sm:w-40 md:w-72 shrink-0 shadow-2xl rounded-xl overflow-hidden border border-white/10 transform shadow-purple-500/20 transition-transform hover:scale-105">
                        <img src={item.poster} class="w-full h-auto object-cover" />
                      </div>
                      <div class="max-w-2xl text-center md:text-left">
                        <div class="flex items-center justify-center md:justify-start gap-2 mb-3">
                          <span class="bg-purple-600 text-[9px] md:text-[10px] font-bold px-2 py-0.5 rounded uppercase">Trending</span>
                          <span class="text-gray-400 text-[10px] md:text-xs">{item.year} • HD</span>
                        </div>
                        <h1 class="text-2xl md:text-6xl font-black mb-3 text-white leading-tight line-clamp-2 drop-shadow-md">{item.title}</h1>
                        <p class="text-gray-400 text-[11px] md:text-base mb-6 line-clamp-2 md:line-clamp-4 leading-relaxed max-w-lg mx-auto md:mx-0">
                          {item.description || "Nonton film subtitle Indonesia terlengkap dan terupdate hanya di Nobarin."}
                        </p>
                        <a
                          href={`/nonton/${item.detailPath}`}
                          class="w-full md:w-fit px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-full font-bold flex items-center justify-center space-x-2 transition-all active:scale-95 shadow-lg shadow-purple-600/30"
                        >
                          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7z" />
                          </svg>
                          <span>Mulai Menonton</span>
                        </a>
                      </div>
                    </div>
                  </div>
                ))
              }
            </div>
            <div
              class="swiper-button-prev-custom absolute left-4 md:left-10 top-1/2 -translate-y-1/2 z-30 cursor-pointer p-3 rounded-full glass hover:bg-purple-600/50 transition-all duration-300 text-white group"
            >
              <svg class="w-6 h-6 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                ><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg
              >
            </div>
            <div
              class="swiper-button-next-custom absolute right-4 md:right-10 top-1/2 -translate-y-1/2 z-30 cursor-pointer p-3 rounded-full glass hover:bg-purple-600/50 transition-all duration-300 text-white group"
            >
              <svg class="w-6 h-6 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                ><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg
              >
            </div>
            <div class="swiper-pagination"></div>
          </div>
        </section>

        <section class="px-6 md:px-12 py-8 overflow-x-auto whitespace-nowrap scrollbar-hide flex space-x-4 no-scrollbar">
          <button
            onclick="changeCategory('trending', this)"
            class="cat-btn active px-6 py-2 rounded-full glass hover:bg-purple-600 transition bg-purple-600">Trending</button
          >
          <button onclick="changeCategory('indonesian-movies', this)" class="cat-btn px-6 py-2 rounded-full glass hover:bg-purple-600 transition"
            >Indo Movie</button
          >
          <button onclick="changeCategory('indonesian-drama', this)" class="cat-btn px-6 py-2 rounded-full glass hover:bg-purple-600 transition"
            >Indo Drama</button
          >
          <button onclick="changeCategory('kdrama', this)" class="cat-btn px-6 py-2 rounded-full glass hover:bg-purple-600 transition">K-Drama</button>
          <button onclick="changeCategory('anime', this)" class="cat-btn px-6 py-2 rounded-full glass hover:bg-purple-600 transition">Anime</button>
          <button onclick="changeCategory('short-tv', this)" class="cat-btn px-6 py-2 rounded-full glass hover:bg-purple-600 transition">Short TV</button>
        </section>

        <section class="px-6 md:px-12 pb-20">
          <h2 class="text-2xl font-semibold mb-6 flex items-center" id="sectionTitle">
            <span class="w-2 h-8 bg-purple-600 rounded-full mr-3"></span> Populer Sekarang
          </h2>

          <div id="movieGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-8">
            {
              initialGrid.map((item: any) => (
                <a
                  href={`/nonton/${item.detailPath}`}
                  class="group relative bg-white/5 rounded-xl overflow-hidden cursor-pointer movie-card shadow-xl block"
                  data-aos="fade-up"
                >
                  <div class="aspect-[2/3] overflow-hidden">
                    <img
                      src={item.poster}
                      alt={item.title}
                      class="w-full h-full object-cover group-hover:scale-110 transition duration-500"
                      loading="lazy"
                    />
                  </div>
                  <div class="absolute inset-0 bg-gradient-to-t from-dark via-transparent to-transparent opacity-80" />
                  <div class="absolute bottom-0 p-4 w-full">
                    <div class="flex items-center space-x-2 text-xs mb-1">
                      <span class="bg-purple-600 px-2 py-0.5 rounded text-white">{item.rating || "N/A"} ⭐</span>
                      <span class="text-gray-300">{item.year}</span>
                    </div>
                    <h3 class="font-semibold truncate text-white">{item.title}</h3>
                    <p class="text-xs text-gray-400 capitalize">{item.type}</p>
                  </div>
                </a>
              ))
            }
          </div>

          <div class="mt-12 flex justify-center space-x-4" id="pagination">
            <button id="prevBtn" onclick="changePage(-1)" class="px-6 py-2 glass rounded-lg opacity-50 cursor-not-allowed">Previous</button>
            <button id="nextBtn" onclick="changePage(1)" class="px-6 py-2 bg-purple-600 rounded-lg hover:bg-purple-700">Next Page</button>
          </div>
        </section>

        <section id="resumeSection" class="px-6 md:px-12 py-8 hidden" data-aos="fade-down">
          <h2 class="text-xl font-bold mb-6 flex items-center text-white">
            <svg class="w-5 h-5 mr-2 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Lanjutkan Menonton
          </h2>
          <div id="resumeGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
        </section>

        <script is:inline>
          document.addEventListener("DOMContentLoaded", function () {
            new Swiper(".heroSwiper", {
              loop: true,
              effect: "fade",
              fadeEffect: { crossFade: true },
              speed: 1000,
              autoplay: { delay: 5000, disableOnInteraction: false },
              pagination: { el: ".swiper-pagination", clickable: true },
              navigation: { nextEl: ".swiper-button-next-custom", prevEl: ".swiper-button-prev-custom" },
            });

            renderResumeSection();
          });

          const API_BASE = "https://zeldvorik.ru/apiv3/api.php";
          let currentCategory = "trending";
          let currentPage = 1;

          async function changeCategory(cat, btn) {
            currentCategory = cat;
            currentPage = 1;

            document.querySelectorAll(".cat-btn").forEach((b) => b.classList.remove("bg-purple-600", "active"));
            if (btn) btn.classList.add("bg-purple-600", "active");

            document.getElementById("sectionTitle").innerHTML =
              `<span class="w-2 h-8 bg-purple-600 rounded-full mr-3"></span> ${cat.replace("-", " ").toUpperCase()}`;

            loadContent();
          }

          async function changePage(direction) {
            currentPage += direction;
            if (currentPage < 1) currentPage = 1;
            loadContent();
            document.getElementById("movieGrid").scrollIntoView({ behavior: "smooth" });
          }

          async function loadContent() {
            const grid = document.getElementById("movieGrid");
            grid.innerHTML = Array(10).fill('<div class="rounded-xl overflow-hidden aspect-[2/3] animate-pulse bg-white/10"></div>').join("");

            try {
              const url = `${API_BASE}?action=${currentCategory}&page=${currentPage}`;
              const res = await fetch(url);
              const data = await res.json();

              if (data.success) {
                renderGrid(data.items);

                const prevBtn = document.getElementById("prevBtn");
                if (currentPage > 1) {
                  prevBtn.classList.remove("opacity-50", "cursor-not-allowed");
                } else {
                  prevBtn.classList.add("opacity-50", "cursor-not-allowed");
                }
              }
            } catch (e) {
              console.error(e);
              grid.innerHTML = '<p class="text-center col-span-full">Gagal memuat data.</p>';
            }
          }

          function renderGrid(items) {
            const grid = document.getElementById("movieGrid");
            grid.innerHTML = items
              .map(
                (item) => `
                  <a href="/nonton/${item.detailPath}" class="group relative bg-white/5 rounded-xl overflow-hidden cursor-pointer movie-card shadow-xl block" data-aos="fade-up">
                      <div class="aspect-[2/3] overflow-hidden">
                          <img src="${item.poster}" alt="${item.title}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                      </div>
                      <div class="absolute inset-0 bg-gradient-to-t from-dark via-transparent to-transparent opacity-80"></div>
                      <div class="absolute bottom-0 p-4 w-full">
                          <div class="flex items-center space-x-2 text-xs mb-1">
                              <span class="bg-purple-600 px-2 py-0.5 rounded text-white">${item.rating || "N/A"} ⭐</span>
                              <span class="text-gray-300">${item.year}</span>
                          </div>
                          <h3 class="font-semibold truncate text-white">${item.title}</h3>
                          <p class="text-xs text-gray-400 capitalize">${item.type}</p>
                      </div>
                  </a>
              `,
              )
              .join("");
          }

          function renderResumeSection() {
            const STORAGE_KEY = "nobar_history";

            const rawData = localStorage.getItem(STORAGE_KEY);

            if (!rawData) {
              document.getElementById("resumeSection").classList.add("hidden");
              return;
            }

            try {
              const history = JSON.parse(rawData);

              const historyArray = Object.values(history);

              if (historyArray.length === 0) {
                document.getElementById("resumeSection").classList.add("hidden");
                return;
              }

              historyArray.sort((a, b) => b.timestamp - a.timestamp);

              const container = document.getElementById("resumeSection");
              const grid = document.getElementById("resumeGrid");

              container.classList.remove("hidden");

              grid.innerHTML = historyArray
                .slice(0, 4)
                .map(
                  (item) => `
                    <a href="/nonton/${item.detailPath}" class="relative group cursor-pointer overflow-hidden rounded-xl glass border border-white/5 block hover:border-purple-500/50 transition-all">
                        <div class="aspect-video relative">
                            <img src="${item.poster}" class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition duration-500">
                            
                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300">
                                <div class="bg-purple-600/90 p-2 rounded-full shadow-lg backdrop-blur-sm">
                                  <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                                </div>
                            </div>
                            
                            <div class="absolute bottom-0 left-0 w-full h-1 bg-white/20">
                                <div class="h-full bg-purple-500" style="width: ${Math.random() * 40 + 20}%"></div>
                            </div>
                        </div>
                        
                        <div class="absolute bottom-0 p-3 w-full bg-gradient-to-t from-dark via-dark/80 to-transparent">
                            <div class="flex justify-between items-end">
                                <div class="overflow-hidden">
                                    <p class="text-[10px] text-purple-400 font-bold uppercase tracking-wider mb-0.5">
                                        ${item.type === "tv" ? "Lanjut Nonton" : "Movie"}
                                    </p>
                                    <h3 class="text-xs font-bold text-white truncate w-full">${item.title}</h3>
                                </div>
                                
                                ${
                                  item.type === "tv"
                                    ? `
                                    <div class="shrink-0 ml-2">
                                        <span class="bg-purple-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-md">
                                            Ep ${item.lastEpisode}
                                        </span>
                                    </div>
                                `
                                    : ""
                                }
                            </div>
                        </div>
                    </a>
                  `,
                )
                .join("");
            } catch (error) {
              console.error("Error parsing history:", error);
            }
          }
        </script>
      </>
    )
  }
</MainLayout>
