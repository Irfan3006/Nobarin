---
import MainLayout from "../../layouts/MainLayout.astro";
import { fetchWithCache } from "../../lib/movieCache"; // Cache

const { slug } = Astro.params;

let movie = null;
let episodes = [];

try {
  const targetUrl = `https://zeldvorik.ru/apiv3/api.php?action=detail&detailPath=${slug}`;
  const data = await fetchWithCache(targetUrl, 60 * 60 * 1000);

  if (data && data.success) {
    movie = data.data;
    if (movie.seasons) {
      episodes = movie.seasons;
    } else {
      const raw = movie.episodes || movie.list_episode || movie.episode || [];
      episodes = Array.isArray(raw) ? raw : Object.values(raw);
    }
  } else {
    return Astro.redirect("/404");
  }
} catch (e: unknown) {
  console.error("Error Detail Page:", e instanceof Error ? e.message : String(e));
  return Astro.redirect("/404");
}

if (!movie) {
  return Astro.redirect("/404");
}

function truncateWords(text: string, limit = 155) {
  if (!text) return "";
  return text.split(" ").slice(0, 25).join(" ") + "...";
}
---

<MainLayout
  title={`Nonton ${movie.title} Subtitle Indonesia | Nobarin`}
  description={`Streaming ${movie.title} (${movie.year}) subtitle Indonesia. ${truncateWords(movie.description)}`}
  og={{
    title: `Nonton ${movie.title} Subtitle Indonesia | Nobarin`,
    description: `Streaming film ${movie.title} (${movie.year}) subtitle Indonesia kualitas HD. Sinopsis: ${truncateWords(movie.description)}`,
    image: movie.poster,
    url: `https://nobarin.netlify.app/nonton/${slug}`,
    type: movie.type === "tv" ? "video.tv_show" : "video.movie",
  }}
  schema={{
    "@context": "https://schema.org",
    "@type": "Movie",
    "@id": `https://nobarin.netlify.app/nonton/${slug}#movie`,
    url: `https://nobarin.netlify.app/nonton/${slug}`,
    name: movie.title,
    description: movie.description,
    datePublished: `${movie.year}-01-01`,
    image: [movie.poster],

    ...(movie.rating && {
      aggregateRating: {
        "@type": "AggregateRating",
        ratingValue: Number(movie.rating),
        ratingCount: Math.floor(Math.random() * (20000 - 500 + 1)) + 500,
        bestRating: 10,
        worstRating: 1,
      },
    }),
  }}
>
  <div class="container mx-auto px-4 py-24 min-h-screen">
    <a href="/" class="inline-flex items-center text-gray-400 hover:text-white mb-6 transition-colors">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
        ><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg
      >
      Kembali ke Beranda
    </a>

    <div class="flex flex-col lg:flex-row gap-8">
      <div class="w-full lg:w-2/3 order-1 lg:order-2">
        <div id="playerContainer" class="aspect-video w-full bg-black rounded-xl overflow-hidden shadow-2xl ring-1 ring-purple-500/30 relative">
          <iframe id="videoPlayer" src={movie.playerUrl} class="w-full h-full" allowfullscreen frameborder="0" allow="autoplay; encrypted-media"
          ></iframe>
        </div>

        <div class="mt-6 border-b border-white/10 pb-6">
          <h1 class="text-2xl md:text-4xl font-bold text-white mb-3 leading-tight">Nonton {movie.title} Subtitle Indonesia</h1>
          <div class="flex flex-wrap gap-3 text-sm">
            <span class="bg-purple-600 text-white px-2 py-0.5 rounded text-xs font-bold flex items-center">{movie.rating || "N/A"} ⭐</span>
            <span class="bg-white/10 text-gray-300 px-2 py-0.5 rounded text-xs font-bold">{movie.year}</span>
            <span class="bg-white/10 text-purple-300 px-2 py-0.5 rounded text-xs font-bold capitalize">{movie.type}</span>
            <span class="text-gray-500">•</span>
            <span class="text-gray-400">{movie.genre}</span>
            <p class="text-gray-400 text-sm leading-relaxed max-w-3xl">
              Streaming film {movie.title} ({movie.year}) subtitle Indonesia. Tonton online kualitas HD hanya di Nobarin.
            </p>
          </div>
        </div>
        <div class="mt-8">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-bold text-white uppercase tracking-widest border-l-4 border-purple-500 pl-3">Daftar Episode</h3>
            <span class="text-xs text-gray-500 italic">Klik untuk memutar</span>
          </div>

          <div class="max-h-[400px] overflow-y-auto pr-2 custom-scrollbar p-1">
            {
              movie.seasons ? (
                movie.seasons.map((season: any) => (
                  <div class="mb-4">
                    <div class="sticky top-0 bg-dark/95 backdrop-blur z-10 py-2 mb-2 border-b border-white/5">
                      <p class="text-purple-400 font-bold text-xs uppercase tracking-wider">Season {season.season}</p>
                    </div>
                    <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2">
                      {season.episodes.map((ep: any, idx: number) => (
                        <button
                          class="ep-btn group relative py-2 bg-white/5 hover:bg-purple-600 active:bg-purple-700 rounded text-[11px] font-bold transition-all border border-white/5 text-center truncate px-1"
                          data-url={ep.url || ep.playerUrl}
                          data-ep={ep.episode || idx + 1}
                        >
                          <span class="group-hover:text-white text-gray-300">Ep {ep.episode || idx + 1}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                ))
              ) : (
                <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2">
                  {episodes.map((ep: any, idx: number) => (
                    <button
                      class="ep-btn group py-2 bg-white/5 hover:bg-purple-600 active:bg-purple-700 rounded text-[11px] font-bold transition-all border border-white/5 text-center truncate px-1"
                      data-url={ep.url || ep.playerUrl}
                      data-ep={ep.episode || idx + 1}
                    >
                      <span class="group-hover:text-white text-gray-300">Ep {ep.episode || idx + 1}</span>
                    </button>
                  ))}
                </div>
              )
            }
          </div>
        </div>

        <div class="mt-12 glass p-6 rounded-2xl">
          <h3 class="text-lg font-bold text-white mb-4 uppercase tracking-widest border-b border-white/10 pb-2">Komentar</h3>
          <div id="disqus_thread" class="min-h-[200px]"></div>
        </div>
      </div>

      <div class="w-full lg:w-1/3 order-2 lg:order-1">
        <div class="sticky top-24">
          <div class="relative group rounded-xl overflow-hidden shadow-2xl mb-6 border border-white/10">
            <img
              src={movie.poster}
              class="w-full h-auto object-cover transform group-hover:scale-105 transition duration-700"
              alt={`Nonton ${movie.title} Subtitle Indonesia Poster`}
              loading="lazy"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-dark/80 to-transparent pointer-events-none"></div>
          </div>

          <div class="glass p-5 rounded-xl border border-white/5">
            <h4 class="text-purple-400 font-bold mb-3 uppercase text-xs tracking-wider flex items-center">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                ><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path></svg
              >
              Sinopsis
            </h4>
            <p class="text-gray-400 text-sm leading-relaxed text-justify">{movie.description || "Tidak ada sinopsis tersedia untuk film ini."}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ movie, slug }}>
    const STORAGE_KEY = "nobar_history";

    function markButtonAsWatched(btn) {
      if (!btn.classList.contains("watched-episode")) {
        btn.classList.add("watched-episode", "bg-purple-900/40", "border-purple-500/50");
        btn.classList.remove("bg-white/5", "border-white/5");

        const span = btn.querySelector("span");
        if (span) span.classList.add("text-purple-300");
      }
    }

    function saveProgress(episodeNumber) {
      try {
        let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        const epInt = parseInt(episodeNumber);

        let currentData = history[slug] || {};
        let watchedList = currentData.watchedEpisodes || [];

        if (!watchedList.includes(epInt)) {
          watchedList.push(epInt);
        }

        history[slug] = {
          title: movie.title,
          poster: movie.poster,
          detailPath: slug,
          lastEpisode: epInt,
          watchedEpisodes: watchedList,
          type: movie.type,
          timestamp: Date.now(),
        };

        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));

        const currentBtn = document.querySelector(`.ep-btn[data-ep="${episodeNumber}"]`);
        if (currentBtn) markButtonAsWatched(currentBtn);
      } catch (e) {
        console.error("Gagal update progress:", e);
      }
    }

    function initPageVisit() {
      try {
        let history = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
        let data = history[slug];

        if (data) {
          data.timestamp = Date.now();

          if (!data.watchedEpisodes) {
            data.watchedEpisodes = data.lastEpisode ? [data.lastEpisode] : [];
          }
        } else {
          data = {
            title: movie.title,
            poster: movie.poster,
            detailPath: slug,
            lastEpisode: 1,
            watchedEpisodes: [],
            type: movie.type,
            timestamp: Date.now(),
          };
        }

        history[slug] = data;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));

        return data;
      } catch (e) {
        console.error("Gagal init page visit:", e);
        return null;
      }
    }

    const currentData = initPageVisit();

    if (currentData && currentData.watchedEpisodes) {
      const buttons = document.querySelectorAll(".ep-btn");
      buttons.forEach((btn) => {
        const epNum = parseInt(btn.getAttribute("data-ep"));
        if (currentData.watchedEpisodes.includes(epNum)) {
          markButtonAsWatched(btn);
        }
      });
    }

    const container = document.getElementById("playerContainer");
    const buttons = document.querySelectorAll(".ep-btn");

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const url = btn.getAttribute("data-url");
        const epNum = btn.getAttribute("data-ep");

        saveProgress(epNum);

        Swal.fire({
          toast: true,
          position: "top-end",
          icon: "info",
          title: `Memutar Episode ${epNum}...`,
          showConfirmButton: false,
          timer: 1500,
          background: "#1e1b4b",
          color: "#fff",
        });

        if (url.includes(".mp4") || url.includes("video-proxy.php")) {
          container.innerHTML = `
                  <video id="videoPlayer" controls autoplay class="w-full h-full rounded-xl bg-black">
                      <source src="${url}" type="video/mp4">
                  </video>`;
        } else {
          container.innerHTML = `
                  <iframe id="videoPlayer" src="${url}" class="w-full h-full rounded-xl"
                      allowfullscreen frameborder="0" allow="autoplay; encrypted-media">
                  </iframe>`;
        }
        container.scrollIntoView({ behavior: "smooth", block: "center" });
      });
    });

    var disqus_config = function () {
      this.page.url = window.location.href;
      this.page.identifier = slug;
    };
    (function () {
      if (document.getElementById("disqus-script")) return;
      var d = document,
        s = d.createElement("script");
      s.src = "https://nobarin-1.disqus.com/embed.js";
      s.id = "disqus-script";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
</MainLayout>
